;; nft-defi-simple.clar - NFT DeFi Contract
;; Implements lending and staking for NFTs

;; Error codes
(define-constant err-unauthorized (err u100))
(define-constant err-not-found (err u101))
(define-constant err-excessive-borrow (err u102))
(define-constant err-lock-period-not-met (err u103))

;; Lending protocol
(define-map nft-loans
  { loan-id: uint }
  {
    nft-id: uint,
    borrower: principal,
    collateral-value: uint,
    borrowed-amount: uint,
    interest-rate: uint, ;; basis points (500 = 5%)
    start-block: uint,
    due-block: uint,
    status: (string-ascii 20)
  }
)

;; NFT Staking
(define-map nft-stakes
  { stake-id: uint }
  {
    nft-id: uint,
    staker: principal,
    staked-at-block: uint,
    lock-period: uint, ;; blocks
    apy: uint, ;; basis points
    rewards-claimed: uint
  }
)

;; Data variables
(define-data-var loan-counter uint u0)
(define-data-var stake-counter uint u0)

;; Borrow sBTC against NFT
(define-public (borrow-against-nft (nft-id uint) (amount uint))
  (let (
    (loan-id (+ (var-get loan-counter) u1))
    (floor-price u100000000) ;; Assume 1 sBTC value
    (max-borrow (/ (* floor-price u50) u100)) ;; 50% LTV
  )
    ;; Verify borrow amount <= max
    (asserts! (<= amount max-borrow) err-excessive-borrow)
    
    ;; Record loan
    (map-set nft-loans
      { loan-id: loan-id }
      {
        nft-id: nft-id,
        borrower: tx-sender,
        collateral-value: floor-price,
        borrowed-amount: amount,
        interest-rate: u500, ;; 5% APY
        start-block: burn-block-height,
        due-block: (+ burn-block-height u4320), ;; ~30 days
        status: "active"
      }
    )
    
    (var-set loan-counter loan-id)
    (ok loan-id)
  )
)

;; Repay loan and reclaim NFT
(define-public (repay-loan (loan-id uint))
  (let (
    (loan (unwrap! (map-get? nft-loans { loan-id: loan-id }) err-not-found))
    (blocks-passed (- burn-block-height (get start-block loan)))
    ;; Calculate interest: principal * rate * time
    (interest (/ (* (* (get borrowed-amount loan) (get interest-rate loan)) blocks-passed) u1000000))
    (total-repay (+ (get borrowed-amount loan) interest))
  )
    ;; Verify borrower
    (asserts! (is-eq tx-sender (get borrower loan)) err-unauthorized)
    
    ;; Mark loan repaid
    (map-set nft-loans { loan-id: loan-id } (merge loan { status: "repaid" }))
    
    (ok true)
  )
)

;; Stake NFT
(define-public (stake-nft (nft-id uint) (lock-period uint))
  (let (
    (stake-id (+ (var-get stake-counter) u1))
    ;; APY based on lock period
    (apy (if (is-eq lock-period u1008) u1000 ;; 7d = 10% APY
      (if (is-eq lock-period u4320) u1500 ;; 30d = 15% APY
        u2000))) ;; 90d+ = 20% APY
    (nft-level u1) ;; Assume level 1 for simplicity
    ;; Bonus APY for high-level NFTs
    (final-apy (+ apy (* nft-level u10)))
  )
    ;; Record stake
    (map-set nft-stakes
      { stake-id: stake-id }
      {
        nft-id: nft-id,
        staker: tx-sender,
        staked-at-block: burn-block-height,
        lock-period: lock-period,
        apy: final-apy,
        rewards-claimed: u0
      }
    )
    
    (var-set stake-counter stake-id)
    (ok stake-id)
  )
)

;; Claim staking rewards
(define-public (claim-staking-rewards (stake-id uint))
  (let (
    (stake (unwrap! (map-get? nft-stakes { stake-id: stake-id }) err-not-found))
    (blocks-staked (- burn-block-height (get staked-at-block stake)))
    ;; Rewards = (NFT value * APY * time) / blocks per year
    (nft-value u100000000) ;; Assume 1 sBTC value
    (rewards (/ (* (* nft-value (get apy stake)) blocks-staked) u52560)) ;; ~1 year of blocks
    (unclaimed-rewards (- rewards (get rewards-claimed stake)))
  )
    (asserts! (is-eq tx-sender (get staker stake)) err-unauthorized)
    
    ;; Update claimed amount
    (map-set nft-stakes
      { stake-id: stake-id }
      (merge stake { rewards-claimed: rewards })
    )
    
    (ok unclaimed-rewards)
  )
)

;; Unstake NFT
(define-public (unstake-nft (stake-id uint))
  (let (
    (stake (unwrap! (map-get? nft-stakes { stake-id: stake-id }) err-not-found))
    (blocks-staked (- burn-block-height (get staked-at-block stake)))
  )
    (asserts! (is-eq tx-sender (get staker stake)) err-unauthorized)
    (asserts! (>= blocks-staked (get lock-period stake)) err-lock-period-not-met)
    
    ;; Claim any remaining rewards
    (try! (claim-staking-rewards stake-id))
    
    (ok true)
  )
)
